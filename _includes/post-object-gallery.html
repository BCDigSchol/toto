{%- assign raw = include.post.object_location | default: "" -%}
{%- if raw != "" -%}
  {%- assign items = raw | split: ";" -%}
  {%- assign captions_raw = include.post.caption | default: "" | split: ";" -%}
  {%- assign idSuffix = include.post.id | default: include.post.title | slugify -%}

  <div class="post-gallery mb-4">
    {%- assign total = items | size -%}
    {%- assign remaining = total | minus: 5 -%}
    <div class="gallery-social" style="display:flex;gap:0.5rem;align-items:stretch;">
      <!-- Left: large preview (first image) -->
      <div class="gallery-left" style="flex:1 1 60%;min-width:0;">
        {%- assign first = items[0] | default: '' -%}
        {%- if first != '' -%}
          {%- assign full0 = '/objects/' | append: first | relative_url -%}
          <button class="gallery-thumb gallery-large" data-gallery-id="gallery-{{ idSuffix }}" data-index="0" style="border:0;padding:0;background:transparent;cursor:pointer;width:100%;height:100%;">
            <img src="{{ full0 }}" alt="{{ captions_raw[0] | default: '' | strip }}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;display:block;box-shadow:0 6px 18px rgba(0,0,0,0.12);border:1px solid rgba(0,0,0,0.06);" />
          </button>
        {%- endif -%}
      </div>

      <!-- Right thumbnails placeholder - handled by conditional below -->
        <!-- Right: stacked thumbnails (show up to 4). If only two images, make the single right thumb full-height. -->
        {%- if total == 2 -%}
          <div class="gallery-right" style="width:40%;display:flex;flex-direction:column;gap:0.5rem;min-width:0;align-items:stretch;">
            {%- assign src = items[1] | strip -%}
            {%- if src != '' -%}
              {%- assign full = '/objects/' | append: src | relative_url -%}
              <button class="gallery-thumb" data-gallery-id="gallery-{{ idSuffix }}" data-index="1" style="border:0;padding:0;background:transparent;position:relative;overflow:hidden;border-radius:6px;height:100%;">
                <img src="{{ full }}" alt="{{ captions_raw[1] | default: '' | strip }}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.06);" />
              </button>
            {%- endif -%}
          </div>
        {%- else -%}
          <div class="gallery-right" style="width:40%;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:1fr;gap:0.5rem;min-width:0;">
            {%- for img in items -%}
              {%- assign idx = forloop.index0 -%}
              {%- if idx == 0 -%}
                {%- continue -%}
              {%- endif -%}
              {%- if idx > 4 -%}
                {%- continue -%}
              {%- endif -%}
              {%- assign src = img | strip -%}
              {%- if src != "" -%}
                  {%- assign full = '/objects/' | append: src | relative_url -%}
                  <button class="gallery-thumb" data-gallery-id="gallery-{{ idSuffix }}" data-index="{{ idx }}" style="border:0;padding:0;background:transparent;position:relative;overflow:hidden;border-radius:6px;{%- if total == 4 and idx == 3 -%}grid-column:1 / -1;{%- endif -%}">
                    <img src="{{ full }}" alt="{{ captions_raw[idx] | default: '' | strip }}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.06);" />
                    {%- if idx == 4 and remaining > 0 -%}
                      <span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);color:#fff;font-size:1.25rem;font-weight:600;">+{{ remaining }}</span>
                    {%- endif -%}
                  </button>
                {%- endif -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
    </div>

    <!-- Modal -->
    <div id="gallery-{{ idSuffix }}-modal" class="gallery-modal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;padding:1rem;">
      <button class="gallery-close" aria-label="Close" style="position:absolute;top:1rem;right:1rem;background:transparent;border:none;color:#fff;font-size:1.75rem;cursor:pointer;">×</button>
      <div style="max-width:95%;max-height:95%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div style="position:relative;width:100%;display:flex;align-items:center;justify-content:center;">
          <button class="gallery-prev" aria-label="Previous" style="position:absolute;left:0;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;padding:1rem;">‹</button>
          <img id="gallery-{{ idSuffix }}-img" src="" alt="" style="max-width:100%;max-height:80vh;object-fit:contain;border-radius:6px;box-shadow:0 8px 30px rgba(0,0,0,0.6);" />
          <button class="gallery-next" aria-label="Next" style="position:absolute;right:0;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#fff;font-size:2rem;cursor:pointer;padding:1rem;">›</button>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;margin-top:.5rem;gap:1rem;width:100%;">
          <div id="gallery-{{ idSuffix }}-caption" style="color:#ddd;font-size:0.95rem;text-align:center;max-width:90%;"></div>
          <button class="gallery-fullscreen" aria-label="Fullscreen" style="background:transparent;border:1px solid rgba(255,255,255,0.15);color:#fff;padding:.35rem .6rem;border-radius:6px;cursor:pointer;font-size:.9rem;">⤢</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var id = 'gallery-{{ idSuffix }}';
        var items = [
          {%- for img in items -%}
            "{{ '/objects/' | append: img | strip | relative_url }}"{{ unless forloop.last }},{{ endunless }}
          {%- endfor -%}
        ];
        var captions = [
          {%- for c in captions_raw -%}
            "{{ c | strip | escape }}"{{ unless forloop.last }},{{ endunless }}
          {%- endfor -%}
        ];

        function qs(sel, ctx){ return (ctx||document).querySelector(sel); }
        function qsa(sel, ctx){ return Array.prototype.slice.call((ctx||document).querySelectorAll(sel)); }

        var modal = qs('#' + id + '-modal');
        var modalImg = qs('#' + id + '-img');
        var modalCaption = qs('#' + id + '-caption');
        var closeBtn = qs('#' + id + '-modal .gallery-close');
        var prevBtn = qs('#' + id + '-modal .gallery-prev');
        var nextBtn = qs('#' + id + '-modal .gallery-next');
        var fsBtn = qs('#' + id + '-modal .gallery-fullscreen');

        if (!modal) return;

        var current = 0;

        function openAt(i){
          current = (i||0);
          modalImg.src = items[current];
          modalImg.alt = captions[current] || '';
          modalCaption.textContent = captions[current] || '';
          modal.style.display = 'flex';
          // focus to enable key handling
          setTimeout(function(){ modal.focus && modal.focus(); }, 50);
        }

        function closeModal(){
          modal.style.display = 'none';
          modalImg.src = '';
        }

        function showNext(){ current = (current+1) % items.length; openAt(current); }
        function showPrev(){ current = (current-1+items.length) % items.length; openAt(current); }

        // delegate thumbs
        document.addEventListener('click', function(e){
          var t = e.target.closest && e.target.closest('.gallery-thumb');
          if (!t) return;
          if (t.dataset && t.dataset.galleryId === id){
            var idx = parseInt(t.dataset.index,10) || 0;
            openAt(idx);
          }
        });

        closeBtn && closeBtn.addEventListener('click', closeModal);
        prevBtn && prevBtn.addEventListener('click', function(e){ e.stopPropagation(); showPrev(); });
        nextBtn && nextBtn.addEventListener('click', function(e){ e.stopPropagation(); showNext(); });
        modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });

        document.addEventListener('keydown', function(e){
          if (modal.style.display !== 'flex') return;
          if (e.key === 'Escape') closeModal();
          if (e.key === 'ArrowRight') showNext();
          if (e.key === 'ArrowLeft') showPrev();
        });

        // fullscreen
        fsBtn && fsBtn.addEventListener('click', function(){
          var el = modalImg;
          if (!el) return;
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else if (el.requestFullscreen) {
            el.requestFullscreen();
          } else if (el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen();
          }
        });
      })();
    </script>
  </div>
{%- endif -%}
