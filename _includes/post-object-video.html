{%- assign obj = include.post.object_location | default: "" -%}
{%- if obj != "" -%}
  {%- comment -%} derive a basename (remove common extensions) {%- endcomment -%}
  {%- assign name = obj | replace: '.mp4','' | replace: '.mov','' | replace: '.avi','' | replace: '.mkv','' | replace: '.webm','' -%}
  {%- assign converted_rel = '/objects/converted_mp4/' | append: name | append: '.mp4' -%}
  {%- assign converted_url = converted_rel | relative_url -%}

  {%- assign orig_ext = obj | split:'.' | last | downcase -%}
  {%- if orig_ext == 'mp4' -%}
    {%- assign orig_mime = 'video/mp4' -%}
  {%- elsif orig_ext == 'mov' -%}
    {%- assign orig_mime = 'video/quicktime' -%}
  {%- elsif orig_ext == 'avi' -%}
    {%- assign orig_mime = 'video/x-msvideo' -%}
  {%- else -%}
    {%- assign orig_mime = 'application/octet-stream' -%}
  {%- endif -%}

  {%- assign obj_url = '/objects/' | append: obj | relative_url -%}

  <div class="post-video mb-4 rounded overflow-hidden border" style="max-height:480px; background:#000;">
    <video id="video-{{ include.post.id | default: include.post.title | slugify }}" class="w-full h-auto" controls preload="metadata" playsinline muted style="width:100%;height:100%;object-fit:contain;background:#000;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.12);border:1px solid rgba(0,0,0,0.06);">
      <!-- try converted MP4 first (preferred for web) -->
      <source src="{{ converted_url }}" type="video/mp4">
      <!-- fallback to original uploaded object -->
      <source src="{{ obj_url }}" type="{{ orig_mime }}">
      Your browser does not support the video element. You can <a href="{{ converted_url }}">download the video</a> instead.
    </video>
    {% if include.post.caption %}
    <div class="video-caption text-sm text-gray-600 mt-2">{{ include.post.caption }}</div>
    {% endif %}
    <div id="video-fallback-{{ include.post.id | default: include.post.title | slugify }}" style="display:none;margin-top:.5rem;color:#fff;">
      <p>Video format may not be supported in your browser. <a href="{{ obj_url }}" style="color:#cce4ff;">Download</a> or try a modern browser (Chrome, Firefox, Safari).</p>
    </div>
  </div>

  <script>
    (function(){
      try{
        // If a global media autoplay manager is present, let it handle HTML5 videos
        if (window.__mediaAutoplayManager) return;
        var vid = document.getElementById('video-{{ include.post.id | default: include.post.title | slugify }}');
        if (!vid) return;
        var can = '';
        try { can = vid.canPlayType && vid.canPlayType('{{ mime }}'); } catch(e) { can = ''; }
        if (!can || can === 'no') {
          var fb = document.getElementById('video-fallback-{{ include.post.id | default: include.post.title | slugify }}');
          if (fb) fb.style.display = 'block';
        }
      } catch(e) {
        /* fail silently */
      }
    })();
  </script>

  <script>
    (function(){
      try{
        // prefer locating by explicit id (most robust); fallback to matching source URLs
        var vidId = 'video-{{ include.post.id | default: include.post.title | slugify }}';
        var vid = document.getElementById(vidId);
        if (!vid) {
          // fallback: try to find a video whose first source src matches our converted_url or obj_url
          var conv = '{{ converted_url }}';
          var obju = '{{ obj_url }}';
          var vids = document.querySelectorAll('video');
          for (var i=0;i<vids.length;i++){
            try{
              var s = vids[i].querySelector && vids[i].querySelector('source');
              var src = s && (s.getAttribute('src') || s.src) || '';
              if (src && (src.indexOf(conv) !== -1 || src.indexOf(obju) !== -1)) { vid = vids[i]; break; }
            }catch(e){}
          }
        }
        if (!vid) {
          if (window.__videoAutoplayDebug) console.warn('autoplay script: video element not found', vidId);
          return;
        }

        // Respect users who prefer reduced motion
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

        // If user manually paused, don't re-autoplay
        vid.addEventListener('pause', function(){ if (!vid._autoPaused) vid.dataset.userPaused = '1'; });
        vid.addEventListener('play', function(){ delete vid.dataset.userPaused; });

        var obsTarget = container || vid;
        var thresholds = [0, 0.25, 0.5, 0.75, 1];
        var observer = new IntersectionObserver(function(entries){
          entries.forEach(function(entry){
            try{
              if (entry.intersectionRatio >= 0.5) {
                if (vid.dataset.userPaused) return;
                try { vid.muted = true; vid.setAttribute('muted', ''); } catch(e){}
                var p = vid.play();
                if (p && p.catch) p.catch(function(){});
              } else {
                if (!vid.paused) { vid._autoPaused = true; vid.pause(); vid._autoPaused = false; }
              }
            }catch(e){}
          });
        }, { threshold: thresholds });

        observer.observe(obsTarget);

        // Pause when page hidden to save resources
        document.addEventListener('visibilitychange', function(){ if (document.hidden) { try{ vid.pause(); }catch(e){} } });

        // Clean up if video is removed from DOM
        var rmObserver = new MutationObserver(function(mutations){ if (!document.body.contains(vid)) { try{ observer.disconnect(); rmObserver.disconnect(); }catch(e){} } });
        rmObserver.observe(document.body, { childList: true, subtree: true });

      } catch(e) { /* fail silently */ }
    })();
  </script>

{%- endif -%}
